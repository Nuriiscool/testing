<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nuri | Social Links</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* Все предыдущие стили остаются без изменений */
    /* ... */
    
    /* Новые стили для формы аутентификации */
    .auth-form {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
      width: 90%;
      max-width: 400px;
    }
    .auth-form input {
      margin: 10px 0;
      width: 100%;
      padding: 10px;
    }
  </style>
</head>
<body>
  <!-- Весь предыдущий HTML остаётся -->
  <!-- ... -->

  <!-- Добавляем форму для входа -->
  <div id="auth-form" class="auth-form">
    <h3>Admin Login</h3>
    <input type="email" id="auth-email" placeholder="Email">
    <input type="password" id="auth-password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="hideAuthForm()" style="background: #e74c3c; margin-top: 10px;">Cancel</button>
  </div>

  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script>
    // ======================
    // 1. FIREBASE AUTH IMPLEMENTATION
    // ======================
    const firebaseConfig = {
      apiKey: "AIzaSyBwjcK9brfOAwlkojOfYgMO_dFY-DNvEvQ",
      authDomain: "nuri-test-95cc5.firebaseapp.com",
      databaseURL: "https://nuri-test-95cc5-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nuri-test-95cc5",
      storageBucket: "nuri-test-95cc5.firebasestorage.app",
      messagingSenderId: "440508513511",
      appId: "1:440508513511:web:f85ed92675fd040aad3642"
    };

    // SECURITY: Инициализация с обработкой ошибок
    try {
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const database = firebase.database();
    } catch (err) {
      console.error("Firebase init error", err);
      document.getElementById('status-message').textContent = "Service unavailable";
    }

    // Функции для работы с аутентификацией
    function showAuthForm() {
      document.getElementById('auth-form').style.display = 'block';
    }

    function hideAuthForm() {
      document.getElementById('auth-form').style.display = 'none';
    }

    async function login() {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        hideAuthForm();
        showAdminPanel();
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    }

    // ======================
    // 2. API KEY PROTECTION
    // ======================
    // SECURITY: Эти настройки нужно сделать в Google Cloud Console:
    // 1. Перейдите https://console.cloud.google.com/apis/credentials
    // 2. Выберите ваш API ключ
    // 3. Включите ограничения:
    //    - HTTP-рефереры: nuriiscool.github.io
    //    - API: Firebase Management API, Firebase Rules API

    // ======================
    // UPDATED ADMIN FUNCTIONS
    // ======================
    function showAdminPanel() {
      // Проверяем аутентификацию вместо пароля
      if (!auth.currentUser) {
        showAuthForm();
        return;
      }
      
      database.ref('status').once('value').then((snapshot) => {
        const currentStatus = snapshot.val() || {};
        document.getElementById('status-select').value = currentStatus.state || 'online';
        document.getElementById('status-custom-text').value = currentStatus.message || '';
        document.getElementById('admin-overlay').style.display = 'flex';
      });
    }

    function updateStatus() {
      if (!auth.currentUser) {
        alert("Please login first!");
        return;
      }

      const status = document.getElementById('status-select').value;
      const text = document.getElementById('status-custom-text').value;
      
      database.ref('status').set({
        state: status,
        message: text,
        updatedBy: auth.currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
        alert("Status updated!");
      });
    }

    // ======================
    // FIREBASE RULES (must update in Firebase console)
    // ======================
    /*
    {
      "rules": {
        "status": {
          ".read": true,
          ".write": "auth != null && 
                   newData.child('updatedBy').val() == auth.uid"
        }
      }
    }
    */

    // Инициализация
    auth.onAuthStateChanged((user) => {
      if (user) {
        console.log("User logged in:", user.email);
      }
    });

    particlesJS("particles-js", { 
      /* конфиг частиц без изменений */ 
    });
  </script>
</body>
</html>
